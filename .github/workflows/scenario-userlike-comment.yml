name: scenario

on:
  pull_request:

permissions:
  contents: read
  pull-requests: write

jobs:
  userlike:
    name: scenario(userlike)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sticky PR comment (in progress)
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: scenario-testing
          message: |
            ⏳ **scenario testing: in progress**

            **Workflow run:** `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`

      - name: Detect changed scenarios
        id: detect
        uses: dorny/paths-filter@v3
        with:
          filters: |
            should_run:
              - "tests/scenario/**/*.scenario.test.ts"
              - "tests/test-utils.ts"
              - "scripts/run-scenarios.mjs"
              - "vitest.scenario.config.ts"

      - name: Compute affected scenario files
        id: files
        if: steps.detect.outputs.should_run == 'true'
        shell: bash
        run: |
          set -euo pipefail

          BASE="${{ github.event.pull_request.base.sha }}"
          HEAD="${{ github.event.pull_request.head.sha }}"

          CHANGED="$(git diff --name-only "$BASE" "$HEAD")"

          # If shared scenario infra changed, run all scenario tests.
          if echo "$CHANGED" | grep -E -q '^(tests/test-utils\.ts|scripts/run-scenarios\.mjs|vitest\.scenario\.config\.ts)$'; then
            ALL="$(git ls-files 'tests/scenario/**/*.scenario.test.ts')"
            printf "%s\n" "$ALL" > /tmp/scenario_files.txt
          else
            ONLY="$(echo "$CHANGED" | grep -E '^tests/scenario/.*\.scenario\.test\.ts$' || true)"
            printf "%s\n" "$ONLY" > /tmp/scenario_files.txt
          fi

          if [ ! -s /tmp/scenario_files.txt ]; then
            echo "files=" >> "$GITHUB_OUTPUT"
            echo "files_md=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          FILES="$(cat /tmp/scenario_files.txt)"
          echo "files<<EOF" >> "$GITHUB_OUTPUT"
          echo "$FILES" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

          echo "files_md<<EOF" >> "$GITHUB_OUTPUT"
          while IFS= read -r f; do
            [ -z "$f" ] && continue
            echo "- \`$f\`"
          done < /tmp/scenario_files.txt >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright (with deps)
        run: npx playwright install --with-deps

      # Optional: enable CLI video recording (best-effort)
      - name: Install asciinema + ffmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y asciinema ffmpeg

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install agg
        run: |
          # asciinema/agg (terminal recording -> gif) is used to convert CLI casts to mp4.
          # crates.io "agg" is a different library crate (no binaries), so install from git.
          cargo install --locked --git https://github.com/asciinema/agg || \
          cargo install --git https://github.com/asciinema/agg --force || true

      - name: Run affected scenarios in userlike mode
        env:
          SCENARIO_MODE: userlike
          SCENARIO_FILES: ${{ steps.files.outputs.files }}
        run: |
          if [ -z "${SCENARIO_FILES:-}" ]; then
            echo "No scenario files changed; skipping userlike scenarios."
            exit 0
          fi
          node scripts/run-scenarios.mjs

      - name: Upload userlike artifacts (videos)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scenario-userlike-videos
          path: artifacts/user-style-e2e

      - name: Sticky PR comment (done)
        if: success() && github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: scenario-testing
          message: |
            ✅ **scenario testing: done**

            **Scenarios executed:**
            ${{ steps.files.outputs.files_md }}

            **Artifacts:** download `scenario-userlike-videos` from the workflow run.
            **Workflow run:** `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`

      - name: Sticky PR comment (fail)
        if: failure() && github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: scenario-testing
          message: |
            ❌ **scenario testing: failed**

            **Scenarios attempted:**
            ${{ steps.files.outputs.files_md }}

            **Next steps:**
            - Open the workflow run logs to see the failure
            - Download `scenario-userlike-videos` artifacts (if any) for visual debugging

            **Workflow run:** `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`

  smokecheck:
    name: scenario(smokecheck)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright (with deps)
        run: npx playwright install --with-deps

      - name: Scenario tests (smokecheck)
        run: npm run test:scenario:smoke

      - name: Upload smokecheck logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: scenario-smokecheck-logs
          path: .cache/smokecheck

